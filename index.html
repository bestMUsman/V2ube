<!doctype html>
<html>

<head>
  <title>Socket.IO chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font: 13px Helvetica, Arial;
    }
    
    .chatSection form {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    .chatSection form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: .5%;
    }

    .chatSection form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
    }

    .chatSection #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }

    .chatSection #messages li {
      padding: 5px 10px;
      font-size: 25px;
    }

    .chatSection #messages li:nth-child(odd) {
      background: #eee;
    }

    #chatContainer {
      display: none;
    }
  
  </style>
</head>

<body>

  <!-- Youtube Section Starts -->
  <div class="youtubeSection">
    <div id="submitUrlContainer">
      <form action="">
        <input id="submitUrl" autocomplete="off" value='https://www.youtube.com/watch?v=V8_wEZD160g' /><button>Submit</button>
      </form>
    </div>
    <div id="player"></div>
  </div>
  <!--Youtube Ends-->

  <!-- Chat Section Starts -->
  <div class="chatSection">
    <div id="setNameContainer">
      <form action="">
        <input id="setNameBox" autocomplete="off" /><button>Enter</button>
      </form>
    </div>

    <div id="chatContainer">
      <ul id="messages"></ul>
      <form action="">
        <input id="m" autocomplete="off" /><button>Send</button>
      </form>
    </div>
  </div>
  <!-- Chat Ends -->



  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script>
    
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '390',
        width: '640',
        // playerVars: { 'autoplay': 0, },
        playerVars: { rel: 0 },
        videoId: '',
        events: {
          // 'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    var socket = io();

    /* Chat Section Starts in Script */
   
      $('#chatContainer form').submit(function () {
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });

      socket.on('new message', function (data) {
        $('#messages').append($('<li>').text(data.name + ': ' + data.msg));
      });

      $('#setNameContainer form').submit(function () {
        socket.emit('user joined', $('#setNameBox').val());
        $('#setNameBox').val('');
        let setNameBox = document.getElementById('setNameBox');
        setNameBox.style.display = 'none';
        let chatContainer = document.getElementById('chatContainer');
        chatContainer.style.display = 'block';
        return false;
      });

      socket.on('got new user', function (data) {
        $('#messages').append($('<li>').text(data.name + ' has joined the chat!'));
      });

      socket.on('user got disconnected', function (data) {
        $('#messages').append($('<li>').text(data.name + ' has left the chat!'));
      });

    /* Chat Ends in Script */

    /* Youtube Section Starts in Script  */
        $('#submitUrlContainer form').submit(function () {
          console.log('the whole url => ', $('#submitUrl').val());
          let url = $('#submitUrl').val().split('https://www.youtube.com/watch?v=').pop().trim();
          socket.emit('sending url to server', url);
          $('#submitUrl').val('');
          return false;
        });

        let isVideoBeingPlayed = false;
        var firsTimeLoaded = true;

        socket.on("sending url to everyone", function (data) {
          console.log('url id=>', data.url);
          player.loadVideoById(data.url)
        });

        socket.on('playing video for everyone', function () {
          player.playVideo();
        });

        socket.on('pausing video for everyone', function () {
          player.pauseVideo();
        });

        socket.on('send this time to everyone', function (time) {
          if (time.time != undefined) {
            console.log('PRINT THE CURRENT TIME ONLY WHEN IT IS NOT UNDEFINED ', time.time.time);
            player.seekTo(time.time.time, true)
          }
        });

        // function onPlayerReady(event) {
        //   console.log('this is workin inside onplayerready');
        // }

        function onPlayerStateChange(event) {
          console.log('State Change => ', event.data);

          // To play the video for everyone
          if (event.data == 1 && firsTimeLoaded == false) {
            socket.emit("play video now to server");
          }

          // To pause the video for everyone
          if (event.data == 2 && firsTimeLoaded == false) {
            socket.emit("pause video now to server");
          }

          // To Stop Video In the Beggining
          if (event.data == 1 && firsTimeLoaded == true) {
            console.log('firsTimeLoaded ', firsTimeLoaded);
            player.stopVideo();
            firsTimeLoaded = false;
            console.log('firsTimeLoaded ', firsTimeLoaded);
            console.log('=====================');
          }
          // To change the video time for everyone
          else if (event.data == 3 && firsTimeLoaded == false) {
            console.log('now it is time to get new time');
            let currentTime = player.getCurrentTime();
            if (currentTime != undefined) {
              socket.emit("new time send to server", {
                time: currentTime,
              });
            }
          }

          // if (event.data == YT.PlayerState.PLAYING && !done) {
          //   setTimeout(stopVideo, 6000);
          //   done = true;
          // }
        }



    /* Youtube Ends in Script  */
  </script>

</body>

</html>